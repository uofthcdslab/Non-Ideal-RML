<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Non-Ideal RML Methodology Mapper</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
    </script>
    <style>
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background-color: #f8f9fa; color: #333; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
        
        .main-layout { display: flex; gap: 30px; align-items: flex-start; }
        
        /* Left Column: Inputs */
        .input-panel { flex: 1; min-width: 400px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #555; font-size: 0.9em; }
        .input-group textarea { 
            width: 100%; height: 80px; padding: 10px; 
            border: 1px solid #e1e4e8; border-radius: 6px; 
            font-family: monospace; font-size: 13px; resize: vertical; 
            transition: border-color 0.2s;
        }
        .input-group textarea:focus { border-color: #3498db; outline: none; }
        
        button.update-btn { 
            width: 100%; padding: 12px; background-color: #2c3e50; color: white; 
            border: none; border-radius: 6px; font-weight: bold; cursor: pointer; 
            font-size: 16px; transition: background 0.2s; margin-top: 10px;
        }
        button.update-btn:hover { background-color: #34495e; }

        /* Right Column: Graph */
        .graph-panel { flex: 2; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 800px; display: flex; justify-content: center; align-items: center; overflow: auto; }
        
        /* Legend */
        .legend { margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; font-size: 0.8em; color: #666; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }

    </style>
</head>
<body>

    <h1>Non-Ideal RML Methodology Mapper</h1>

    <div class="main-layout">
        <div class="input-panel">
            
            <div class="input-group">
                <label for="input_UP">1. Undesirable Properties (UP) List</label>
                <textarea id="input_UP" placeholder="Separate with semicolon (;)">feature dependencies; high-cardinal categorical features; incomplete operationalization of seasonal variations; incomplete operationalization of larger focus of ML system; target vairable confounders</textarea>
            </div>

            <div class="input-group">
                <label for="input_UP_RG">2. Connections: UP -> RG (Realized Goals)</label>
                <textarea id="input_UP_RG" placeholder="UP -> RG; UP -> RG">feature dependencies -> robust to high-cardinal data; high-cardinal categorical features->robust to high-cardinal data; high-cardinal categorical features->robust to distribution shift; incomplete operationalization of seasonal variations->robust to distribution shift; incomplete operationalization of seasonal variations->robust to class imbalance; incomplete operationalization of larger focus of ML system -> robust to distribution shift; target vairable confounders -> robust to class imbalance</textarea>
            </div>

            <div class="input-group">
                <label for="input_RG_AV">3. Connections: RG -> AV (Abstract Values)</label>
                <textarea id="input_RG_AV" placeholder="RG -> AV; RG -> AV">robust to high-cardinal data->robustness; robust to distribution shift->robustness; robust to class imbalance->robustness</textarea>
            </div>

            <div class="input-group">
                <label for="input_IV_UP">4. Connections: IV (Interventions) -> UP</label>
                <textarea id="input_IV_UP" placeholder="IV -> UP; IV -> UP">selecting highest-performing data encoding->high-cardinal categorical features; selecting highest performing model type -> high-cardinal categorical features; implementing a new evaluation metric for model tuning -> incomplete operationalization of seasonal variations; evaluation metric for model tuning ->target variable confounders; evaluation experiments to mimic real-world settings->incomplete operationalization of seasonal variations</textarea>
            </div>

            <div class="input-group">
                <label for="input_KA_IV">5. Connections: KA (Known Assumptions) -> IV</label>
                <textarea id="input_KA_IV" placeholder="KA -> IV; KA -> IV">negligble effects of model hyperparameters->selecting high-performing data encoding; negligble effects of model hyperparameters->selecting highest-performing model type; no influence of other operationalizations of target variable -> implementing a new evaluation metric for model tuning; no influence of other operationalizations of target variable->evaluation experiments to mimic real-world settings</textarea>
            </div>

            <button class="update-btn" onclick="renderGraph()">Update Graph</button>
            
            <div class="legend">
                <div class="legend-item"><div class="dot" style="background:#f9f9f9; border:1px solid #333"></div>AV (Value)</div>
                <div class="legend-item"><div class="dot" style="background:#dae8fc; border:1px solid #6c8ebf"></div>RG (Goal)</div>
                <div class="legend-item"><div class="dot" style="background:#ffe6cc; border:1px solid #d79b00"></div>UP (Problem)</div>
                <div class="legend-item"><div class="dot" style="background:#d5e8d4; border:1px solid #82b366"></div>IV (Action)</div>
                <div class="legend-item"><div class="dot" style="background:#f5f5f5; border:1px dashed #b85450"></div>KA (Assumption)</div>
            </div>
        </div>

        <div class="graph-panel">
            <div id="graphDiv" class="mermaid"></div>
        </div>
    </div>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

        // Helper to normalize text for IDs (remove spaces, special chars)
        function cleanId(text) {
            return 'node_' + text.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
        }

        window.renderGraph = async function() {
            // Data storage
            let nodes = {}; 
            let edges = []; 

            // Helper to add node if not exists
            function addNode(text, layer) {
                if (!text || text.trim() === '') return null;
                const cleanText = text.trim();
                const id = cleanId(cleanText);
                
                if (!nodes[id]) {
                    nodes[id] = { id: id, text: cleanText, layer: layer };
                }
                return id;
            }

            // 1. Parse UP List (Box 1)
            const upRaw = document.getElementById('input_UP').value.split(';');
            upRaw.forEach(t => addNode(t, 'UP'));

            // 2. Parse UP -> RG (Box 2)
            const upRgRaw = document.getElementById('input_UP_RG').value.split(';');
            upRgRaw.forEach(line => {
                const parts = line.split('->');
                if (parts.length === 2) {
                    const src = addNode(parts[0], 'UP'); 
                    const tgt = addNode(parts[1], 'RG'); 
                    if(src && tgt) edges.push(`${src} --> ${tgt}`);
                }
            });

            // 3. Parse RG -> AV (Box 3)
            const rgAvRaw = document.getElementById('input_RG_AV').value.split(';');
            rgAvRaw.forEach(line => {
                const parts = line.split('->');
                if (parts.length === 2) {
                    const src = addNode(parts[0], 'RG'); 
                    const tgt = addNode(parts[1], 'AV'); 
                    if(src && tgt) edges.push(`${src} --> ${tgt}`);
                }
            });

            // 4. Parse IV -> UP (Box 4)
            const ivUpRaw = document.getElementById('input_IV_UP').value.split(';');
            ivUpRaw.forEach(line => {
                const parts = line.split('->');
                if (parts.length === 2) {
                    const src = addNode(parts[0], 'IV'); 
                    const tgt = addNode(parts[1], 'UP'); 
                    if(src && tgt) edges.push(`${src} --> ${tgt}`);
                }
            });

            // 5. Parse KA -> IV (Box 5)
            const kaIvRaw = document.getElementById('input_KA_IV').value.split(';');
            kaIvRaw.forEach(line => {
                const parts = line.split('->');
                if (parts.length === 2) {
                    const src = addNode(parts[0], 'KA'); 
                    const tgt = addNode(parts[1], 'IV'); 
                    if(src && tgt) edges.push(`${src} --> ${tgt}`);
                }
            });

            // Build Mermaid Definition
            let graphDef = 'graph BT\n'; // Bottom-to-Top orientation

            // Add Nodes
            Object.values(nodes).forEach(n => {
                const label = n.text.replace(/"/g, "'");
                graphDef += `${n.id}["${label}"]\n`;
                graphDef += `class ${n.id} ${n.layer}Node\n`;
            });

            // Add Edges
            const uniqueEdges = [...new Set(edges)];
            uniqueEdges.forEach(e => graphDef += `${e}\n`);

            // Styles
            graphDef += `
                classDef AVNode fill:#f9f9f9,stroke:#333,stroke-width:2px;
                classDef RGNode fill:#dae8fc,stroke:#6c8ebf,stroke-width:2px;
                classDef UPNode fill:#ffe6cc,stroke:#d79b00,stroke-width:2px;
                classDef IVNode fill:#d5e8d4,stroke:#82b366,stroke-width:2px;
                classDef KANode fill:#f5f5f5,stroke:#b85450,stroke-width:2px,stroke-dasharray: 5 5;
            `;

            // Render
            const element = document.getElementById('graphDiv');
            element.removeAttribute('data-processed');
            element.innerHTML = graphDef;
            
            try {
                await mermaid.run({ nodes: [element] });
            } catch (e) {
                console.error(e);
                element.innerHTML = 'Error parsing graph data. Please check for special characters.';
            }
        };

        // Initial Render
        setTimeout(renderGraph, 500);
    </script>
</body>
</html>
